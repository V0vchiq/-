# Nexus – спецификация офлайн-ассистента

## 1. Обзор
- **Платформа**: Flutter (Android для RuStore; поддержка iOS)
- **Путь проекта**: `E:\Projects\Nexus`
- **Тема**: научно-фантастический космос (тёмное звёздное поле, неоновые тессеракты, градиенты туманностей)
- **Офлайн-Модель ИИ**: Gemma 2 2B (GGUF Q5_K_M квантизация, ~1.8 ГБ) через llama.cpp
- **Целевые метрики**: отклик <5 с, точность ≥75–80%, офлайн-первый режим, соответствие требованиям RuStore

## 2. Архитектура

### 2.1 Слоистая структура
- **Представление**: UI на Flutter (состояния через Riverpod; кастомная космическая тема)
- **Домен**: юзкейсы чата
- **Данные**:
  - Локальная БД (sqflite) для истории чата, настроек
  - Безопасное хранилище для учётных данных/токенов
- **Нативные мосты**: MethodChannel для llama.cpp инференса (Kotlin/Swift)

### 2.2 Ключевые модули
1. **Движок ИИ**
   - Обёртка llama.cpp через нативный MethodChannel (LlamaBridge)
   - Модель Gemma 2 2B IT (Q5_K_M)
   - Построитель промптов под русскоязычные домены
   - Онлайн-фолбэк (API DeepSeek) с проверкой подключения
2. **Опыт чата**
   - Менеджер диалога (история, поиск, фильтры, очистка)
   - Текстовый ввод
   - Рендер ответа с индикаторами офлайн/онлайн, стриминг токенов
3. **Настройки**
   - Переключатели тем (cosmos/dark/light)
   - Параметры приложения (язык, офлайн/онлайн режим)

### 2.3 Потоки данных
- Ввод пользователя → предобработка
- Сборка промпта с системными инструкциями + вопрос пользователя
- Нативный мост → llama.cpp инференс → стриминг токенов → UI
- При ошибке инференса → фолбэк-текст или онлайн API
- Онлайн-режим: вызов API DeepSeek с тем же промптом

### 2.4 Стратегия хранения
- **Sqflite**: логи чата, настройки
- **Application Support Dir**: скачанная GGUF модель (~1.8 ГБ)
- **Assets**: конфиги (~несколько КБ в бандле)
- Модель скачивается при первом запуске с HuggingFace

## 3. UI / UX

### 3.1 Сплэш
- **Splash Screen**: анимированный градиент туманности, пульсирующий тессеракт, прогресс загрузки модели

### 3.2 Главный экран чата
- Фон: тёмный космос с еле заметным параллаксом звёзд
- Верх: полупрозрачное приветствие
- Центр: пузыри сообщений (пользователь — неоново-синий справа, ассистент — фиолетовый/белый слева)
- Нижняя панель:
  - Поле ввода с плейсхолдером «Введите вопрос…»
  - Иконка отправить
  - Бейдж онлайн/офлайн

### 3.3 Панель истории
- Доступна через drawer/вкладку
- Список с метками времени, превью текста
- Строка поиска
- Кнопка очистки истории с диалогом подтверждения

### 3.4 Экран настроек
- Карточки выбора темы (cosmos/dark/light)
- Переключатель: офлайн/онлайн режим
- API ключ DeepSeek для онлайн режима

## 4. Интеграция ИИ и llama.cpp

### 4.1 Детали модели
- **Модель**: `google/gemma-2-2b-it` (GGUF)
- **Вариант**: `Q5_K_M` (~1.8 ГБ)
- **Источник**: HuggingFace (скачивается при первом запуске)

### 4.2 Интеграция llama.cpp

#### Android (Kotlin)
- Нативные библиотеки: `ggml-base`, `ggml-cpu`, `ggml`, `llama`, `llama-android`
- Нативный мост через `MethodChannel("nexus/llama")`
- Event Channel для стриминга токенов: `nexus/llama/stream`
- Методы: `loadModel`, `generate`, `generateStream`, `stopGeneration`, `unloadModel`
- GeneratorParams: max_tokens=400

### 4.3 Стратегия загрузки модели
- Сервис **DownloadService** (Foreground Service) обеспечивает:
  - Загрузку с прогрессом
  - Возобновление при обрыве
  - Стриминг прогресса в UI через EventChannel

### 4.4 Шаблон промпта
```
Ты — русскоязычный ассистент Nexus. Отвечай строго на русском языке, 
дружелюбно и по существу. Не задавай встречных вопросов без необходимости 
и не выдумывай новые темы. Если данных недостаточно, честно сообщи об этом. 
Формат ответа — максимум 2-3 предложения.

[Вопрос]
{user_prompt}

[Ответ]
```

### 4.5 Онлайн-фолбэк (API DeepSeek)
- Проверка подключения через `connectivity_plus`
- Безопасное хранение API-ключа в secure storage
- Явный переключатель в настройках

## 5. Безопасность и соответствие требованиям

- Хранение учётных данных в зашифрованном виде (`flutter_secure_storage`)
- Оффлайн — без передачи персональных данных
- Разрешения: запрос минимального набора
- Подготовка чек-листа соответствия RuStore (возрастной рейтинг, форма безопасности данных)
- Локализация на русском; поддержка кириллицы в шрифтах

## 6. Сборка и деплой

### 6.1 Android (RuStore)
- **minSdk**: 26
- **targetSdk**: 34
- Тестирование на устройствах среднего класса

### 6.2 iOS
- **Минимум iOS**: 13.0
- Нативный Swift-мост

## 7. Структура проекта

```
lib/
├── main.dart
└── src/
    ├── app.dart
    ├── core/
    │   ├── bootstrap/app_bootstrap.dart
    │   ├── routing/app_router.dart
    │   └── theme/
    │       ├── app_theme.dart
    │       └── theme_controller.dart
    └── features/
        ├── chat/
        │   ├── application/chat_controller.dart
        │   ├── data/chat_repository.dart
        │   ├── domain/chat_message.dart
        │   └── presentation/
        │       ├── chat_shell.dart
        │       └── widgets/message_bubble.dart
        ├── settings/application/settings_controller.dart
        └── splash/presentation/splash_screen.dart
    └── services/
        ├── ai/
        │   ├── model_service.dart
        │   ├── online_ai_service.dart
        │   └── phi_service.dart
        └── connectivity/connectivity_service.dart

android/app/
├── build.gradle.kts
└── src/main/kotlin/.../
    ├── MainActivity.kt   # LlamaBridge
    └── DownloadService.kt
```

## 8. Зависимости

### Flutter-пакеты
```yaml
dependencies:
  flutter_riverpod: ^2.5.1
  hooks_riverpod: ^2.5.1
  go_router: ^14.2.0
  flutter_secure_storage: ^9.2.2
  dio: ^5.4.3+1
  connectivity_plus: ^6.0.3
  sqflite: ^2.3.3
  path_provider: ^2.1.3
  shared_preferences: ^2.3.1
  crypto: ^3.0.3
  intl: ^0.20.2
  uuid: ^4.4.0
```

### Нативные зависимости
- **Android**: llama.cpp (ggml-base, ggml-cpu, ggml, llama, llama-android)
- **iOS**: llama.cpp

---
