# Nexus – спецификация и план разработки офлайн-ассистента

## 1. Обзор
- **Платформа**: Flutter (Android для RuStore; поддержка iOS)
- **Путь проекта**: `E:\Projects\Nexus`
- **Тема**: научно-фантастический космос (тёмное звёздное поле, неоновые тессеракты, градиенты туманностей)
- **Офлайн-Модель ИИ**: Phi-3 Mini 4k Instruct (INT4 квантизация, ~2.3 ГБ) через ONNX Runtime GenAI
- **Движок RAG**: Запланирован (сейчас заглушка)
- **Целевые метрики**: отклик <5 с, точность ≥75–80%, офлайн-первый режим, соответствие требованиям RuStore

## 2. Архитектура

### 2.1 Слоистая структура
- **Представление**: UI на Flutter (состояния через Riverpod; кастомная космическая тема)
- **Домен**: юзкейсы чата, RAG-поиск, календаря, уведомлений, мини-игр
- **Данные**:
  - Локальная БД (sqflite) для истории чата, настроек
  - Безопасное хранилище для учётных данных/токенов
  - Опциональная онлайн-синхронизация (Firebase Auth при наличии сети)
- **Нативные мосты**: MethodChannel для ONNX Runtime инференса (Kotlin/Swift)

### 2.2 Ключевые модули
1. **Аутентификация и профиль**
   - Email/пароль (оффлайн-хранение хешей)
   - Необязательные Google/Yandex через Firebase Auth (только онлайн)
   - Локальная сессия пользователя в `flutter_secure_storage`
2. **Движок ИИ**
   - Обёртка ONNX Runtime GenAI через нативный MethodChannel
   - Модель Phi-3 Mini 4k Instruct (INT4-RTN-block-32)
   - Построитель промптов под русскоязычные домены
   - RAG-сервис (заглушка, запланирован)
   - Онлайн-фолбэк (API xAI) с проверкой подключения
3. **Опыт чата**
   - Менеджер диалога (история, поиск, фильтры, очистка)
   - Режимы ввода: текст, речь-в-текст (speech_to_text), загрузка файлов (file_picker)
   - Рендер ответа с индикаторами офлайн/онлайн
4. **Утилиты**
   - Календарь (device_calendar) с офлайн-ежедневником
   - Уведомления и будильники (flutter_local_notifications, alarm)
   - Модуль мини-игр (Trivia, «Угадай слово», Cosmic Story Weaver)
5. **Настройки и монетизация**
   - Переключатели тем (cosmos/dark/light)
   - Параметры приложения (язык, голосовой ввод, офлайн/онлайн режим)
   - Заготовка для RuStore Billing

### 2.3 Потоки данных
- Ввод пользователя → предобработка → (опционально) распознавание речи
- RAG: запрос → RagService (заглушка) → список контекста
- Сборка промпта с системными инструкциями + контекст + вопрос пользователя
- Нативный мост → ONNX Runtime GenAI инференс → санитизация ответа → UI
- При ошибке инференса → фолбэк-текст или онлайн API
- Онлайн-режим: вызов API xAI с тем же промптом

### 2.4 Стратегия хранения
- **Sqflite**: логи чата, настройки, очки мини-игр
- **Application Support Dir**: скачанная ONNX модель (~2.3 ГБ)
- **Assets**: файлы токенизатора, конфиги (~несколько КБ в бандле)
- **Кэш**: временные аудио/текстовые файлы
- Модель скачивается при первом запуске с HuggingFace с SHA256 верификацией

## 3. UI / UX (заметки по вайрфреймам)

### 3.1 Сплэш и авторизация
- **Splash Screen**: анимированный градиент туманности, пульсирующий тессеракт, прогресс загрузки модели
- **Login**: поля email/пароль, кнопка «Войти оффлайн», кнопки «Google / Yandex» (отключены оффлайн)
- **Регистрация**: минимальная форма (email, пароль, подтверждение), оффлайн-хеширование

### 3.2 Главный экран чата
- Фон: тёмный космос с еле заметным параллаксом звёзд
- Верх: полупрозрачное приветствие `«Привет, что обсудим сегодня? :)»`
- Центр: пузыри сообщений (пользователь — неоново-синий справа, ассистент — фиолетовый/белый слева)
- Нижняя панель:
  - Поле ввода с плейсхолдером «Введите вопрос…»
  - Иконки: микрофон, прикрепить файл, отправить
  - Бейдж онлайн/офлайн
- Плавающие действия: быстрый доступ к Trivia, Cosmic Story Weaver, Календарю

### 3.3 Панель истории
- Доступна через drawer/вкладку
- Список с метками времени, превью текста
- Строка поиска + фильтр-чипы (ежедневник, история, перевод и т.д.)
- Кнопка очистки истории с диалогом подтверждения

### 3.4 Экран настроек
- Карточки выбора темы (cosmos/dark/light)
- Переключатели: голосовой ввод по умолчанию, уведомления, синхронизация календаря
- Раздел аккаунта: управление логинами, выход
- Плейсхолдер монетизации («Премиум истории — скоро»)

### 3.5 Утилиты
- **Календарь**: помесячный вид с модалкой добавления напоминания
- **Уведомления/Будильники**: простые списки (название, время, переключатель)
- **Игры**:
  - Trivia: карточка с вопросом + варианты ответа
  - «Угадай слово»: индикатор длины слова, поле ввода, обратная связь
- **Cosmic Story Weaver**: текстовая область с сгенерированной историей, кнопки сохранить/поделиться

## 4. Интеграция ИИ и ONNX Runtime

### 4.1 Детали модели
- **Модель**: `microsoft/Phi-3-mini-4k-instruct-onnx`
- **Вариант**: `cpu-int4-rtn-block-32-acc-level-4`
- **Файлы**:
  - `phi3-mini-4k-instruct-cpu-int4-rtn-block-32-acc-level-4.onnx` (~385 МБ)
  - `phi3-mini-4k-instruct-cpu-int4-rtn-block-32-acc-level-4.onnx.data` (~1.9 ГБ)
- **Источник**: HuggingFace (скачивается при первом запуске)
- **Верификация**: SHA256 контрольные суммы

### 4.2 Интеграция ONNX Runtime

#### Android (Kotlin)
```kotlin
dependencies {
    implementation("com.microsoft.onnxruntime:onnxruntime-android:1.18.0")
    implementation(files("libs/onnxruntime-genai-android-0.11.2.aar"))
}
```
- Нативный мост через `MethodChannel("nexus/phi")`
- Методы: `loadModel`, `generate`
- GeneratorParams: max_length=192, temperature=0.4, top_p=0.8, repetition_penalty=1.1

#### iOS (Swift)
```ruby
pod 'onnxruntime-mobile-c', '~> 1.18.0'
pod 'onnxruntime-genai-c', '~> 1.18.0'
```
- Нативный мост через тот же MethodChannel
- Минимум iOS 13.0

### 4.3 Стратегия загрузки модели
- Сервис **PhiModelDownloader** обеспечивает:
  - Параллельную чанковую загрузку (6 потоков, 50МБ чанки)
  - Возобновление с SHA256 валидацией
  - Стриминг прогресса в UI
  - Логику повторов (3 попытки с отступом)
- **Бандлированные ассеты** (конфиги токенизатора) копируются из Flutter assets

### 4.4 Шаблон промпта
```
Ты — русскоязычный ассистент Nexus. Отвечай строго на русском языке, 
дружелюбно и по существу. Не задавай встречных вопросов без необходимости 
и не выдумывай новые темы. Если данных недостаточно, честно сообщи об этом. 
Формат ответа — максимум 2-3 предложения.

[Контекст]
{contexts или "нет дополнительного контекста"}

[Вопрос]
{user_prompt}

[Ответ]
```

### 4.5 Интеграция RAG (запланировано)
- `RagService` сейчас возвращает пустой список контекста
- В будущем: embedding модель + векторный поиск
- Внедрение контекста в шаблон промпта готово

### 4.6 Онлайн-фолбэк (API xAI)
- Проверка подключения через `connectivity_plus`
- Безопасное хранение API-ключа в secure storage
- Rate limiting для приватности; явный переключатель в настройках

## 5. Заметки по реализации функций

### 5.1 Голосовой ввод
- Пакет: `speech_to_text`
- Русская локаль по умолчанию
- Корректная обработка запросов разрешений
- Преобразование транскрипции → поле ввода чата с возможностью редактирования

### 5.2 Прикрепление файлов
- Пакет: `file_picker` (ограничение: текст, PDF, DOC)
- Извлечение текста и передача в RAG-контекст или отображение как вложение

### 5.3 Календарь и уведомления
- Запрос разрешений по требованию
- `device_calendar` для локальных событий (без облачной синхронизации)
- `flutter_local_notifications` + `alarm` для напоминаний/будильников

### 5.4 Мини-игры
- Датасет Trivia хранится локально (JSON); категории: история/наука/спорт
- «Угадай слово» использует оффлайн-словарь русских слов
- Cosmic Story Weaver использует движок ИИ с тематическими инструкциями промпта

### 5.5 Плейсхолдер монетизации
- Интерфейс для интеграции RuStore Billing SDK (без активных покупок)
- UI-плейсхолдер отключён по умолчанию

## 6. Безопасность и соответствие требованиям

- Хранение учётных данных в зашифрованном виде (`flutter_secure_storage` + хеширование с солью)
- Оффлайн — без передачи персональных данных; онлайн-синхронизация опциональна и прозрачна
- Разрешения: запрос минимального набора с понятными диалогами
- Подготовка чек-листа соответствия RuStore (возрастной рейтинг, форма безопасности данных)
- Локализация преимущественно на русском; поддержка кириллицы в шрифтах
- Логирование: только локальные debug-логи; очистка чувствительных данных

## 7. Сборка и деплой

### 7.1 Android (RuStore)
- **minSdk**: 26
- **targetSdk**: 34
- Варианты сборки: `offline` (по умолчанию), `online` (включает xAI фолбэк)
- При необходимости — split по ABI
- Тестирование на устройствах среднего класса

### 7.2 iOS
- **Минимум iOS**: 13.0
- CocoaPods для зависимостей ONNX Runtime
- Нативный Swift-мост в `AppDelegate.swift`

### 7.3 Непрерывная интеграция
- Локальные скрипты: `flutter analyze`, `flutter test`, `flutter build aab`
- Планируется CI-пайплайн (GitHub Actions/Azure DevOps)

## 8. Структура проекта

```
lib/
├── main.dart
├── core/
│   └── tflite_helper.dart          # Deprecated, оставлен для справки (PhiOnnxAssets)
└── src/
    ├── app.dart
    ├── core/
    │   ├── bootstrap/app_bootstrap.dart
    │   ├── routing/app_router.dart
    │   └── theme/
    │       ├── app_theme.dart
    │       └── theme_controller.dart
    ├── features/
    │   ├── auth/presentation/login_screen.dart
    │   ├── calendar/presentation/calendar_screen.dart
    │   ├── chat/
    │   │   ├── application/chat_controller.dart
    │   │   ├── data/chat_repository.dart
    │   │   ├── domain/chat_message.dart
    │   │   └── presentation/
    │   │       ├── chat_shell.dart
    │   │       └── widgets/message_bubble.dart
    │   ├── games/presentation/game_screens.dart
    │   ├── reminders/presentation/reminder_screen.dart
    │   ├── settings/application/settings_controller.dart
    │   └── splash/presentation/splash_screen.dart
    └── services/
        ├── ai/
        │   ├── online_ai_service.dart
        │   ├── phi_model_downloader.dart
        │   ├── phi_service.dart
        │   └── rag_service.dart
        ├── alarm/alarm_service.dart
        ├── calendar/calendar_service.dart
        ├── connectivity/connectivity_service.dart
        ├── files/file_ingest_service.dart
        ├── notifications/notification_service.dart
        └── speech/speech_service.dart

android/app/
├── build.gradle.kts                 # Зависимости ONNX Runtime
├── libs/onnxruntime-genai-android-0.11.2.aar
└── src/main/kotlin/.../MainActivity.kt   # PhiOnnxBridge

ios/
├── Podfile                          # onnxruntime-mobile-c, onnxruntime-genai-c
└── Runner/
    ├── AppDelegate.swift            # Нативный ONNX мост
    └── Runner-Bridging-Header.h     # импорт ort_genai_c.h
```

## 9. План по фазам

### Фаза 1 – UI/UX ✅
- Космическая тема, вайрфреймы, дизайн-токены
- Scaffolding Splash, Auth, Main Chat, History, Settings
- Базовая навигация/управление состоянием (Riverpod + GoRouter)

### Фаза 2 – Интеграция ИИ ✅
- Интеграция ONNX Runtime GenAI (Android + iOS)
- Загрузка модели с отслеживанием прогресса
- Нативные мосты через MethodChannel
- Шаблон промпта и санитизация ответа

### Фаза 3 – Auth и основные функции (в процессе)
- Завершение email/password auth с secure storage
- Реализация Google/Yandex через Firebase
- Голосовой ввод, прикрепление файлов, календарь, уведомления
- Модули мини-игр

### Фаза 4 – Тестирование и полировка
- Unit/widget тесты для чата, AI-сервиса, утилит
- Стресс-тесты оффлайн
- QA локализации (русские промпты, сообщения об ошибках)
- Подготовка к публикации в RuStore

## 10. Риски и митигации
- **Размер загрузки модели**: Параллельная чанковая загрузка с возобновлением; UI прогресса
- **Совместимость устройств**: INT4 квантизация для CPU; тестирование на средних устройствах
- **Точность голосового распознавания**: Возможность редактирования перед отправкой; фолбэк на текст
- **Лимиты оффлайн-хранилища**: Мониторинг места на устройстве; предупреждение при нехватке
- **Соответствие требованиям**: Регулярная проверка требований приватности/безопасности RuStore

## 11. Зависимости

### Flutter-пакеты
```yaml
dependencies:
  flutter_riverpod: ^2.5.1
  hooks_riverpod: ^2.5.1
  go_router: ^14.2.0
  firebase_core: ^3.4.1
  firebase_auth: ^5.1.4
  google_sign_in: ^6.2.1
  flutter_secure_storage: ^9.2.2
  dio: ^5.4.3+1
  connectivity_plus: ^6.0.3
  speech_to_text: ^7.3.0
  file_picker: ^8.1.2
  device_calendar: ^4.3.1
  flutter_local_notifications: ^17.1.2
  alarm: ^3.0.5
  timezone: ^0.9.2
  sqflite: ^2.3.3
  path_provider: ^2.1.3
  crypto: ^3.0.3
  intl: ^0.19.0
  uuid: ^4.4.0
```

### Нативные зависимости
- **Android**: `onnxruntime-android:1.18.0`, `onnxruntime-genai-android-0.11.2.aar`
- **iOS**: `onnxruntime-mobile-c ~1.18.0`, `onnxruntime-genai-c ~1.18.0`

---
